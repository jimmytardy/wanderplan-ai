# WanderPlan AI - Cursor Rules

## üéØ Vue d'ensemble du projet

Application Next.js 14 fullstack avec App Router pour la planification de voyages assist√©e par IA. Stack technique : TypeScript, Prisma (PostgreSQL), OpenAI, Redis, Material-UI, next-intl.

## üìÅ Structure du projet

### Organisation des fichiers

- `app/` : Next.js App Router
  - `app/api/` : Routes API backend (route.ts)
  - `app/[locale]/` : Pages frontend avec internationalisation
  - `app/layout.tsx` : Layout principal
  - `app/globals.css` : Styles globaux
  - `app/theme.ts` : Configuration Material-UI
  - `app/providers.tsx` : Providers React (MUI, i18n)

- `lib/` : Biblioth√®ques et utilitaires partag√©s
  - `prisma.ts` : Client Prisma singleton (pattern globalThis)
  - `redis.ts` : Client Redis (optionnel, fallback gracieux)
  - `ai.ts` : Service IA avec abstraction multi-provider (OpenAI, Gemini, etc.)
  - `ai/` : Abstraction des providers d'IA
    - `types.ts` : Interfaces et types pour les providers
    - `factory.ts` : Factory pour instancier le provider configur√©
    - `providers/` : Impl√©mentations des providers (OpenAI, Gemini, etc.)
  - `jwt.ts` : Utilitaires JWT
  - `middleware.ts` : Middleware authentification admin
  - `logger.ts` : Syst√®me de logging structur√©
  - `cache-service.ts` : Service de cache intelligent BDD
  - `seo-service.ts` : Service d√©cision SEO
  - `constants.ts` : Constantes partag√©es

- `components/` : Composants React r√©utilisables
  - Composants client-side avec `'use client'`
  - Utilisation de Material-UI pour l'UI

- `prisma/` : Sch√©ma de base de donn√©es
  - `schema.prisma` : Mod√®les Prisma

- `types/` : Types TypeScript partag√©s
  - `index.ts` : Interfaces et types communs

- `scripts/` : Scripts utilitaires (Node.js/TypeScript)
  - Ex√©cut√©s avec `tsx`

- `messages/` : Fichiers de traduction next-intl
  - Format JSON par locale (fr, en, pt, es, it)

- `docs/` : Documentation centralis√©e
  - `ARCHITECTURE.md` : Architecture du projet
  - `SETUP.md` : Guide d'installation d√©taill√©
  - `DOCKER.md` : Guide Docker complet
  - `QUICKSTART.md` : D√©marrage rapide

## üîß Technologies et d√©pendances

### Core
- **Next.js 14** : App Router, Server Components par d√©faut
- **TypeScript** : Mode strict activ√©
- **React 18** : Server/Client Components

### Backend
- **Prisma** : ORM PostgreSQL (singleton pattern)
- **IA Multi-provider** : Abstraction pour OpenAI, Gemini, etc. (configurable via `AI_PROVIDER`)
  - **OpenAI** : API GPT-4/GPT-3.5-turbo (par d√©faut)
  - **Gemini** : Google Gemini (optionnel, n√©cessite `@google/generative-ai`)
- **Redis** : Cache optionnel (fallback si indisponible)
- **JWT** : Authentification admin (jsonwebtoken)
- **bcryptjs** : Hash mots de passe

### Frontend
- **Material-UI (MUI)** : Composants UI
- **next-intl** : Internationalisation (5 locales)
- **date-fns** : Manipulation dates

### Validation & Utils
- **Zod** : Validation de sch√©mas (toujours valider les inputs API)
- **date-fns** : Dates et locales

## üìù Conventions de code

### TypeScript

- **Mode strict** : Toujours activ√©
- **Types explicites** : √âviter `any`, utiliser `unknown` si n√©cessaire
- **Interfaces** : D√©finir dans `types/index.ts` pour types partag√©s
- **Imports** : Utiliser alias `@/` pour imports absolus (configur√© dans tsconfig.json)

### API Routes (app/api/*/route.ts)

```typescript
// Structure standard d'une route API
import { NextRequest, NextResponse } from 'next/server'
import { z } from 'zod'
import { prisma } from '@/lib/prisma'
import { logger } from '@/lib/logger'

// 1. D√©finir sch√©ma Zod pour validation
const schema = z.object({ ... })

// 2. Exporter fonction HTTP (GET, POST, etc.)
export async function POST(request: NextRequest) {
  try {
    // 3. Parser et valider le body
    const body = await request.json()
    const validatedData = schema.parse(body)
    
    // 4. Logique m√©tier
    // ...
    
    // 5. Retourner NextResponse.json avec format standard
    return NextResponse.json({
      success: true,
      data: { ... }
    })
  } catch (error) {
    // 6. Gestion d'erreurs avec logger
    logger.error('Error message', error)
    
    if (error instanceof z.ZodError) {
      return NextResponse.json(
        { success: false, error: 'Donn√©es invalides', details: error.errors },
        { status: 400 }
      )
    }
    
    return NextResponse.json(
      { success: false, error: error.message || 'Erreur' },
      { status: 500 }
    )
  }
}
```

### Authentification Admin

- Utiliser `requireAdmin()` de `lib/middleware.ts` pour routes prot√©g√©es
- Token JWT dans header `Authorization: Bearer <token>`
- V√©rifier l'existence de l'admin en BDD apr√®s v√©rification token

### Base de donn√©es (Prisma)

- **Toujours utiliser** `prisma` depuis `lib/prisma.ts` (singleton)
- **Index** : Ajouter sur colonnes fr√©quemment query√©es
- **Relations** : D√©finir dans schema.prisma
- **Migrations** : Utiliser `npm run db:push` pour d√©veloppement, `db:migrate` pour production

### Cache

- **Redis** : Optionnel, toujours pr√©voir fallback si indisponible
- **Cache BDD** : V√©rifier d'abord en BDD avant appel IA (via `cache-service.ts`)
- **TTL** : 24h pour programmes, 12h pour contenu custom

### Logging

- Utiliser `logger` depuis `lib/logger.ts`
- Niveaux : `info`, `warn`, `error`, `debug`
- Format : `logger.info('Message', { data })`
- Debug uniquement en d√©veloppement

### Internationalisation (i18n)

- **Locales support√©es** : fr, en, pt, es, it
- **Locale par d√©faut** : fr
- Utiliser `useTranslations()` et `useLocale()` dans composants client
- Messages dans `messages/{locale}.json`
- Routes avec `[locale]` dans App Router

### Composants React

- **Server Components par d√©faut** : Pas de `'use client'` sauf si n√©cessaire
- **Client Components** : Ajouter `'use client'` en premi√®re ligne
- **Material-UI** : Utiliser composants MUI pour UI
- **Props** : D√©finir interfaces TypeScript pour props

### Validation

- **Toujours valider** les inputs API avec Zod
- Sch√©mas Zod dans les routes API
- Messages d'erreur en fran√ßais (ou selon locale)
- Retourner erreurs de validation avec status 400

### Gestion d'erreurs

- Try/catch dans toutes les routes API
- Logger les erreurs avec `logger.error()`
- Retourner format standard : `{ success: boolean, error?: string, data?: T }`
- Status HTTP appropri√©s (400, 401, 404, 500)

## üîí S√©curit√©

1. **Validation** : Toujours valider avec Zod avant traitement
2. **Authentification** : JWT pour routes admin, v√©rifier token + existence admin
3. **Mots de passe** : Hash bcrypt (10 rounds minimum)
4. **SQL Injection** : Prisma ORM (pr√©par√© statements automatiques)
5. **Variables d'environnement** : Secrets dans `.env`, jamais en code
6. **CORS** : G√©r√© par Next.js

## üé® UI/UX

- **Material-UI** : Utiliser composants MUI pour coh√©rence
- **Responsive** : Mobile-first, design adaptatif
- **Th√®me** : Personnalis√© dans `app/theme.ts`
- **Accessibilit√©** : Respecter standards ARIA

## üöÄ Performance

- **Cache** : V√©rifier BDD avant appel IA
- **Redis** : Cache optionnel pour requ√™tes lourdes
- **Index BDD** : Sur colonnes fr√©quemment query√©es
- **SSG/SSR** : Next.js pour pages SEO

## üì¶ Scripts pnpm

- `pnpm dev` : D√©veloppement
- `pnpm build` : Build production (g√©n√®re Prisma client)
- `pnpm db:push` : Push sch√©ma Prisma (dev)
- `pnpm db:migrate` : Migration Prisma (prod)
- `pnpm create-admin` : Cr√©er admin
- `pnpm seed` : Seed donn√©es (dev uniquement)

## üê≥ Docker

- Support Docker avec docker-compose
- `Dockerfile` pour production
- `Dockerfile.dev` pour d√©veloppement
- Variables d'environnement dans `.env`

## üìã Format de donn√©es

### R√©ponse API standard

```typescript
{
  success: boolean
  data?: T
  error?: string
  details?: any
}
```

### Programme de voyage (JSON)

```typescript
{
  title: string
  days: Array<{
    day: number
    date?: string
    activities: Array<{
      name: string
      time: string
      duration: string
      description?: string
      location?: string
    }>
    restaurants: Array<{
      name: string
      time: string
      cuisine?: string
      priceRange?: string
      address?: string
    }>
  }>
  budget?: string
  tips?: string[]
  locale?: string // Langue du programme
}
```

## üîÑ Patterns √† suivre

1. **Singleton** : Prisma et Redis (via globalThis en dev)
2. **Abstraction IA** : Utiliser l'interface `AIProvider` pour ajouter de nouveaux providers
3. **Validation** : Zod pour tous les inputs
4. **Cache intelligent** : V√©rifier BDD avant IA
5. **Logging structur√©** : Utiliser logger avec contexte
6. **Gestion d'erreurs** : Try/catch + logger + format standard
7. **Internationalisation** : Support 5 locales, messages dans JSON
8. **Type safety** : TypeScript strict, √©viter `any`

## ‚ö†Ô∏è √Ä √©viter

- ‚ùå Ne pas utiliser `any` en TypeScript
- ‚ùå Ne pas oublier la validation Zod
- ‚ùå Ne pas cr√©er plusieurs instances Prisma
- ‚ùå Ne pas exposer secrets dans le code
- ‚ùå Ne pas oublier le logging d'erreurs
- ‚ùå Ne pas hardcoder les messages (utiliser i18n)
- ‚ùå Ne pas oublier le fallback si Redis indisponible
- ‚ùå Ne pas appeler directement les SDKs d'IA (utiliser l'abstraction `AIProvider`)

## üìö R√©f√©rences

Toute la documentation est centralis√©e dans le r√©pertoire `docs/` :

- Architecture : `docs/ARCHITECTURE.md`
- Setup : `docs/SETUP.md`
- Docker : `docs/DOCKER.md`
- Quickstart : `docs/QUICKSTART.md`
- Documentation technique : `lib/ai/README.md` (abstraction des providers d'IA)

